<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link th:href="@{/css/student/seatMap.css}" rel="stylesheet">
</head>
<body>
    <input type="hidden" id="hashedCid" th:value="${courseHashedId}" />
    <input type="hidden" id="teacherName" th:value="${teacherName}" />
    <input type="hidden" id="hashedTeacherId" th:value="${hashedTeacherId}" />
    <input type="hidden" id="recordId" th:value="${recordId}" />

    <div th:if="${attendanceEntries.size() < 1}">
        <p>This class does no student entry</p>
    </div> 

    <!-- THIS IS WHERE THE SEAT MAPS START -->

    <div id="classroomContainer">
        <div id="seatMapContainer"></div>
        <div id = "teacherSeatContainer">
        <div class = "teacherText">teacher</div>
        </div>
    </div>


    <!-- SEAT MAP ENDS -->

    <div th:if="${attendanceEntries.size() >= 1}">
            <!-- Format the date time, frontend can change the h2 tag -->
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Seat</th>
                        <th>Attendance</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Iterate through attendanceEntries using Thymeleaf -->
                    <tr th:each="attendanceEntry, stat : ${attendanceEntries}">
                        <td th:text="${stat.count}">1</td> <!-- Display count starting from 1 -->
                        <td th:text="${attendanceEntry.user.name}">John Doe</td> <!-- Replace 'name' with the actual property of User for name -->
                        <td th:text="${attendanceEntry.user.email}">john.doe@example.com</td> <!-- Replace 'email' with the actual property of User for email -->
                        <!-- Line 1: Display nothing if seatNumber is equal to -1 -->
                        <td>
                            <span th:if="${attendanceEntry.seatNumber != -1}" th:text="${attendanceEntry.seatNumber}">None</span>
                        </td>

                        <!-- Line 2: Display "checked-in" if the status is true, "absent" if the status is false -->
                        <td>
                            <span th:if="${attendanceEntry.isCheckedIn}" th:id="'attendanceStatusSpan_' + ${attendanceEntry.id}">
                                Checked-in
                            </span>
                            <span th:unless="${attendanceEntry.isCheckedIn}" th:id="'attendanceStatusSpan_' + ${attendanceEntry.id}">
                                Absent
                            </span>
                        </td>
                        <td>
                            <td>
                                <button th:id="'editAttendanceStatusButton_' + ${attendanceEntry.id}" th:onclick="'toggleDropdown(' + ${attendanceEntry.id} + ')'">Edit</button>
                                <button th:id="'saveAttendanceStatusButton_' + ${attendanceEntry.id}" th:style="${'display: none;'}">Save</button>
                            </td>
                            
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <style>
        table {
          border-collapse: collapse;
          width: 100%;
        }
        
        th, td {
          padding: 8px; /* Adjust the value as per your preference */
          text-align: left;
          border-bottom: 1px solid #ddd;
        }
        
      </style>

    
</body>
<script>
    let hashedTeacherId = document.querySelector('#hashedTeacherId').value.trim();
    let hashedCid = document.querySelector('#hashedCid').value.trim();
    let recordId = document.querySelector('#recordId').value.trim();
async function updateAttendanceStatus(entryId, status) {
    // Prepare the data to be sent via AJAX
    console.log(entryId)
    console.log(status)
    console.log(hashedCid)
    console.log(hashedTeacherId)
    var postData = {
        entryId: entryId,
        status: status,
        recordId : recordId
    };
    $.ajax({
        type: 'POST',
        url: '/teacher/' + hashedTeacherId + '/' + hashedCid + '/entry/' + entryId,
        data: postData,
        error: function(xhr, status, error) {
            console.error("BROOOOOOOOOOO", error);
        }
    });
        
       
    }

    function toggleDropdown(entryId) {
    var spanElement = document.getElementById('attendanceStatusSpan_' + entryId);
    var currentStatus = spanElement.textContent.trim();
    
    // If there is already a dropdown, return (to avoid creating a new one)
    if (spanElement.nextElementSibling && spanElement.nextElementSibling.id === 'attendanceStatusDropdown') {
        return;
    }

    // Create the dropdown element
    var dropdown = document.createElement('select');
    dropdown.id = 'attendanceStatusDropdown';
    var options = ["Checked-In", "Absent", "Excused"];
    for (var i = 0; i < options.length; i++) {
        var option = document.createElement('option');
        option.text = options[i];
        dropdown.add(option);
    }
    
    // Set the selected option to the current status
    var selectedIndex = options.indexOf(currentStatus);
    if (selectedIndex !== -1) {
        dropdown.selectedIndex = selectedIndex;
    } else {
        dropdown.selectedIndex = 0; // Default to the first option if status is not recognized
    }

    // Hide the span and show the dropdown
    spanElement.style.display = 'none';
    spanElement.parentNode.insertBefore(dropdown, spanElement.nextSibling);

    // Change the button text from "Edit" to "Save"
    var editButton = document.getElementById('editAttendanceStatusButton_' + entryId);
    editButton.style.display = 'none'; // Hide the "Edit" button
    var saveButton = document.getElementById('saveAttendanceStatusButton_' + entryId);
    saveButton.style.display = 'inline-block'; // Show the "Save" button

    // Add an event listener for the "Save" button
    saveButton.addEventListener('click', function () {
        // Get the selected option from the dropdown
        var selectedOption = dropdown.options[dropdown.selectedIndex].text;

        // Perform the AJAX POST request
        updateAttendanceStatus(entryId, selectedOption)
            .then(function (responseData) {
                // Update the span text with the selected option
                spanElement.textContent = selectedOption;
                // Show the span element again and hide the dropdown
                spanElement.style.display = 'inline-block';
                dropdown.style.display = 'none';
                // Show the "Edit" button again
                editButton.style.display = 'inline-block';
                // Hide the "Save" button
                saveButton.style.display = 'none';
            })
            .catch(function (error) {
                console.error('Error:', error);
            });
    });

    // Add an event listener for the "Edit" button
    editButton.addEventListener('click', function () {
        // Hide the span and show the dropdown
        spanElement.style.display = 'none';
        dropdown.style.display = 'inline-block';
        // Hide the "Edit" button
        editButton.style.display = 'none';
        // Show the "Save" button
        saveButton.style.display = 'inline-block';
    });
}

</script>


<script type="module" th:src="@{/javascript/teacher/attendanceRecord.js}"></script>
</html>
